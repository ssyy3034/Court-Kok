{% extends "base.html" %}

{% block title %}나의 예약 현황 - Court-Kok{% endblock %}

{% block content %}
<div class="w-full max-w-4xl mx-auto flex flex-col" style="min-height: 80vh;">
    {% include 'includes/header.html' %}

    <main class="bg-white p-6 rounded-lg shadow-md flex-grow">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">나의 예약 현황</h1>

        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">내가 만든 모임</h2>
            <div id="created-events-container" class="space-y-4">
                <p class="text-gray-500">데이터를 불러오는 중입니다...</p>
            </div>
        </section>

        <section>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">내가 참여할 모임</h2>
            <div id="attended-events-container" class="space-y-4">
                <p class="text-gray-500">데이터를 불러오는 중입니다...</p>
            </div>
        </section>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- UI Elements ---
  const createdEventsContainer = document.getElementById('created-events-container');
  const attendedEventsContainer = document.getElementById('attended-events-container');

  // --- Helpers ---
  const escapeHtml = (s) => String(s ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

  const sendGetMyRegistrations = () => {
    if (!window.ws || ws.readyState !== WebSocket.OPEN) return;
    showLoader();
    ws.send(JSON.stringify({ action: 'get_my_registrations' }));
    // 7s timeout: 응답이 없으면 로더 해제 및 안내
    const timeoutMs = 7000;
    const marker = Symbol('loading');
    createdEventsContainer._loadingMarker = marker;
    setTimeout(() => {
      if (createdEventsContainer._loadingMarker === marker) {
        hideLoader();
        // 여전히 로딩 문구면 교체
        if (createdEventsContainer.innerText.includes('데이터를 불러오는 중입니다')) {
          createdEventsContainer.innerHTML = `<p class="text-gray-500">데이터를 불러오지 못했습니다. 새로고침해 주세요.</p>`;
        }
        if (attendedEventsContainer.innerText.includes('데이터를 불러오는 중입니다')) {
          attendedEventsContainer.innerHTML = `<p class="text-gray-500">데이터를 불러오지 못했습니다. 새로고침해 주세요.</p>`;
        }
        showAlert('예약 데이터를 불러오지 못했습니다. 잠시 후 다시 시도해 주세요.');
      }
    }, timeoutMs);
  };

  // --- WebSocket Logic ---
  // base.html에서 ws 전역과 connectWebSocket()이 정의되어 있다고 가정
  if (typeof connectWebSocket === 'function') {
    connectWebSocket();
  } else {
    console.error('connectWebSocket()가 없습니다. base.html을 확인하세요.');
    return;
  }
  if (!window.ws) {
    console.error('ws 전역이 없습니다. base.html의 connectWebSocket()에서 ws를 설정해야 합니다.');
    return;
  }

  // 공존 가능하도록 addEventListener 사용
  ws.addEventListener('open', () => {
    sendGetMyRegistrations();
  });

  ws.addEventListener('message', (event) => {
    let data;
    try { data = JSON.parse(event.data); } catch { return; }

    switch (data.type) {
      case 'my_registrations_data': {
        renderMyRegistrations(data.created_events, data.attended_events);
        // timeout 마커 해제
        createdEventsContainer._loadingMarker = undefined;
        hideLoader();
        break;
      }
      case 'event_update': {
        // 다른 곳에서 이벤트 변경 시 재요청
        sendGetMyRegistrations();
        break;
      }
      default:
        // 다른 타입은 무시(기존 핸들러와 공존)
        break;
    }
  });

  // --- UI Rendering ---
  function renderMyRegistrations(createdEvents, attendedEvents) {
    createdEventsContainer.innerHTML = '';
    attendedEventsContainer.innerHTML = '';

    // 내가 만든 모임
    const created = Array.isArray(createdEvents) ? createdEvents : [];
    if (created.length === 0) {
      createdEventsContainer.innerHTML = `<p class="text-gray-500">만든 모임이 없습니다.</p>`;
    } else {
      created.forEach(ev => {
        const parts = Array.isArray(ev.participants_details) ? ev.participants_details : [];
        const participantsHtml = parts.length
          ? parts.map(p => `<li>${escapeHtml(p.name)} (${escapeHtml(p.id)}) - ${escapeHtml(p.phone)}</li>`).join('')
          : '<li>참가자가 아직 없습니다.</li>';

        const countNow = Array.isArray(ev.participants) ? ev.participants.length : 0;
        const card = `
          <div class="border rounded-lg p-4 bg-blue-50">
            <div class="flex justify-between items-start">
              <div>
                <p class="font-bold text-lg text-blue-600">${escapeHtml(ev.date)} @ ${escapeHtml(ev.time)}</p>
                <p class="text-sm text-gray-600">진행 시간: ${escapeHtml(ev.duration)}분</p>
                <p class="text-sm text-gray-600">참여 인원: ${countNow} / ${escapeHtml(ev.max_participants)}명</p>
              </div>
              <button class="delete-btn text-sm bg-gray-700 hover:bg-black text-white font-semibold py-2 px-4 rounded-lg"
                data-event-id="${escapeHtml(ev._id)}">모임 삭제</button>
            </div>
            <div class="mt-4 pt-4 border-t">
              <h4 class="font-semibold text-gray-700">참가자 목록:</h4>
              <ul class="list-disc list-inside mt-2 text-sm text-gray-600">${participantsHtml}</ul>
            </div>
          </div>`;
        createdEventsContainer.insertAdjacentHTML('beforeend', card);
      });
    }

    // 내가 참여할 모임
    const attended = Array.isArray(attendedEvents) ? attendedEvents : [];
    if (attended.length === 0) {
      attendedEventsContainer.innerHTML = `<p class="text-gray-500">참여 신청한 모임이 없습니다.</p>`;
    } else {
      attended.forEach(ev => {
        const countNow = Array.isArray(ev.participants) ? ev.participants.length : 0;
        const cd = ev.creator_details || {};
        const hostLine = `${escapeHtml(cd.name ?? 'N/A')} (${escapeHtml(cd.id ?? 'N/A')}) - ${escapeHtml(cd.phone ?? 'N/A')}`;

        const card = `
          <div class="border rounded-lg p-4 bg-green-50">
            <div class="flex justify-between items-start">
              <div>
                <p class="font-bold text-lg text-green-600">${escapeHtml(ev.date)} @ ${escapeHtml(ev.time)}</p>
                <p class="text-sm text-gray-600">진행 시간: ${escapeHtml(ev.duration)}분</p>
                <p class="text-sm text-gray-600">참여 인원: ${countNow} / ${escapeHtml(ev.max_participants)}명</p>
              </div>
              <button class="cancel-btn text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg"
                data-event-id="${escapeHtml(ev._id)}">예약 취소</button>
            </div>
            <div class="mt-4 pt-4 border-t">
              <h4 class="font-semibold text-gray-700">주최자 정보:</h4>
              <p class="text-sm text-gray-600 mt-1">${hostLine}</p>
            </div>
          </div>`;
        attendedEventsContainer.insertAdjacentHTML('beforeend', card);
      });
    }
  }

  // --- Event Listeners for Buttons ---
  createdEventsContainer.addEventListener('click', async (e) => {
    const btn = e.target.closest('.delete-btn');
    if (!btn) return;
    if (!confirm('모임을 완전히 삭제합니다. 정말 삭제하시겠습니까?')) return;

    showLoader();
    try {
      const eventId = btn.dataset.eventId;
      const response = await authedFetch(`/api/events/${eventId}`, { method: 'DELETE' });
      const result = await response.json().catch(() => ({}));
      showAlert(result.message ?? '요청이 처리되었습니다.');
      // 성공 시 서버가 event_update 방송 → WS가 자동으로 재로딩
    } catch (err) {
      showAlert('삭제에 실패했습니다. 다시 시도해 주세요.');
    } finally {
      hideLoader();
    }
  });

  attendedEventsContainer.addEventListener('click', async (e) => {
    const btn = e.target.closest('.cancel-btn');
    if (!btn) return;
    if (!confirm('정말로 예약을 취소하시겠습니까?')) return;

    showLoader();
    try {
      const eventId = btn.dataset.eventId;
      const response = await authedFetch(`/api/events/${eventId}/signup`, { method: 'DELETE' });
      const result = await response.json().catch(() => ({}));
      showAlert(result.message ?? '요청이 처리되었습니다.');
      // 성공 시 서버가 event_update 방송 → WS가 자동으로 재로딩
    } catch (err) {
      showAlert('예약 취소에 실패했습니다. 다시 시도해 주세요.');
    } finally {
      hideLoader();
    }
  });
});
</script>
{% endblock %}
