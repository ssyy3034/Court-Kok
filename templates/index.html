{% extends "base.html" %}

{% block title %}Court-Kok Calendar{% endblock %}

{% block content %}
<div class="w-full flex flex-col" style="min-height: calc(100vh - 2rem);">
    {% include 'includes/header.html' %}

    <main class="flex w-full flex-grow">
        {% include 'includes/calendar_view.html' %}
        {% include 'includes/daily_schedule.html' %}
        {% include 'includes/event_details.html' %}
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    // =================================================================
    // PAGE-SPECIFIC DOM ELEMENTS
    // =================================================================
    const userNameDisplay = document.getElementById('user-name-display');
    const logoutBtn = document.getElementById('logout-btn');
    const userMenu = document.getElementById('user-menu');
    const userMenuDropdown = document.getElementById('user-menu-dropdown');

    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonthYearDisplay = document.getElementById('current-month-year');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');

    const dailyScheduleContainer = document.getElementById('daily-schedule-container');
    const scheduleDateDisplay = document.getElementById('schedule-date');
    const scheduleSlotsContainer = document.getElementById('schedule-slots');

    const eventDetailsContainer = document.getElementById('event-details-container');
    const createEventView = document.getElementById('create-event-view');
    const viewEventAvailable = document.getElementById('view-event-available');
    const viewEventFull = document.getElementById('view-event-full');
    const durationOptions = document.getElementById('duration-options');
    const createEventBtn = document.getElementById('create-event-submit-btn');
    const signupEventBtn = document.getElementById('signup-event-btn');

    // =================================================================
    // STATE MANAGEMENT
    // =================================================================
    let currentDate = new Date();
    let selectedDate = null;
    let selectedTimeSlot = null;
    let selectedDuration = null;
    let selectedEventId = null;

    // =================================================================
    // AUTH & API HELPERS
    // =================================================================
    const authHeaders = () => ({ 'Authorization': `Bearer ${getToken()}`, 'Content-Type': 'application/json' });

    const authedFetch = async (url, options = {}) => {
        const res = await fetch(url, { ...options, headers: { ...options.headers, ...authHeaders() } });
        if (res.status === 401 || res.status === 422) {
            clearToken();
            window.location.href = '/login';
            throw new Error('Unauthorized');
        }
        return res;
    };

    const handleLogout = async () => {
        showLoader();
        try {
            await authedFetch('/api/logout', { method: 'POST' });
        } catch (error) {
            console.error("Logout failed:", error);
        } finally {
            clearToken();
            window.location.href = '/login';
            hideLoader();
        }
    };

    // =================================================================
    // WEBSOCKET SETUP
    // =================================================================
    let ws = null;
    let reconnectInterval;

    const connectWebSocket = () => {
        const token = getToken();
        if (!token) {
            console.error("No JWT token found, cannot connect to WebSocket.");
            clearToken();
            window.location.href = '/login';
            return;
        }

        if (ws && ws.readyState === WebSocket.OPEN) {
            return;
        }

        ws = new WebSocket(`ws://${window.location.host}/ws?token=${token}`);

        ws.onopen = () => {
            console.log("WebSocket 연결 성공.");
            clearInterval(reconnectInterval);
            reconnectInterval = null;
            ws.send(JSON.stringify({ action: "get_user_info" }));
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            handleWsMessage(data);
        };

        ws.onclose = () => {
            console.log("WebSocket 연결 종료.");
            if (!reconnectInterval) {
                reconnectInterval = setInterval(() => {
                    console.log("WebSocket 재연결 시도 중...");
                    connectWebSocket();
                }, 5000);
            }
        };

        ws.onerror = (err) => {
            console.error("WebSocket 오류:", err);
            ws.close();
        };
    };

    const handleWsMessage = (data) => {
        switch (data.type) {
            case 'user_info':
                userNameDisplay.textContent = data.userName;
                hideLoader();
                break;
            case 'events_list':
                renderDailyScheduleContent(data.events);
                hideLoader();
                break;
            case 'event_update':
                if(selectedDate) {
                    renderDailySchedule(selectedDate);
                }
                break;
            case 'success':
                showAlert(data.message);
                break;
            case 'error':
                showAlert(data.message);
                break;
        }
    };

    // =================================================================
    // UI RENDERING FUNCTIONS
    // =================================================================
    function renderCalendar(date) {
        if (!calendarGrid || !currentMonthYearDisplay) return;
        calendarGrid.innerHTML = '';
        const year = date.getFullYear();
        const month = date.getMonth();
        currentMonthYearDisplay.textContent = `${year}년 ${month + 1}월`;

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) calendarGrid.insertAdjacentHTML('beforeend', `<div></div>`);

        for (let day = 1; day <= lastDateOfMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const today = new Date();
            const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
            const todayClass = isToday ? 'bg-blue-500 text-white font-bold' : 'hover:bg-gray-100';
            const cell = `<div class="date-cell h-12 flex items-center justify-center cursor-pointer rounded-lg ${todayClass}" data-date="${dateStr}">${day}</div>`;
            calendarGrid.insertAdjacentHTML('beforeend', cell);
        }
    }

    async function renderDailySchedule(dateStr) {
        showLoader();
        scheduleDateDisplay.textContent = dateStr;
        scheduleSlotsContainer.innerHTML = '';

        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ action: "get_events", date: dateStr }));
        } else {
            showAlert("WebSocket is not connected. Please refresh the page.");
            hideLoader();
        }
    }

    function renderDailyScheduleContent(events) {
        const eventMap = new Map();
        events.forEach(event => {
            const startTime = event.time;
            for (let i = 0; i < event.duration; i += 30) {
                const slotDate = new Date(`${selectedDate}T${startTime}:00`);
                slotDate.setMinutes(slotDate.getMinutes() + i);
                const slotTime = `${String(slotDate.getHours()).padStart(2, '0')}:${String(slotDate.getMinutes()).padStart(2, '0')}`;
                eventMap.set(slotTime, { isStart: i === 0, event: event });
            }
        });

        for (let hour = 8; hour < 22; hour++) {
            for (let minute = 0; minute < 60; minute += 30) {
                const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                const slotEventInfo = eventMap.get(timeStr);
                const borderClass = minute === 0 ? 'border-t-2 border-gray-400' : 'border-t border-dashed border-gray-300';
                let slotClass = 'bg-gray-200 hover:bg-gray-300 text-gray-500';
                let slotText = timeStr;
                let slotType = 'empty';
                let eventData = '{}';

                if (slotEventInfo) {
                    const isFull = slotEventInfo.event.current >= slotEventInfo.event.max;
                    slotClass = isFull ? 'bg-pink-300 text-white' : 'bg-green-300 text-white';
                    slotType = isFull ? 'full' : 'available';
                    eventData = JSON.stringify(slotEventInfo.event);
                    if (slotEventInfo.isStart) {
                        slotText = `${timeStr} - ${slotEventInfo.event.current}/${slotEventInfo.event.max}`;
                    } else {
                        slotText = `&nbsp;`;
                        slotClass += ' opacity-80';
                    }
                }

                const slot = `<div class="time-slot h-10 flex items-center px-3 text-sm ${borderClass} ${slotClass} cursor-pointer"
                             data-time="${timeStr}" data-type="${slotType}" data-event='${eventData}'>${slotText}</div>`;
                scheduleSlotsContainer.insertAdjacentHTML('beforeend', slot);
            }
        }
    }

    function showEventDetailView(viewToShow) {
        createEventView.classList.add('hidden');
        viewEventAvailable.classList.add('hidden');
        viewEventFull.classList.add('hidden');
        eventDetailsContainer.classList.toggle('hidden', viewToShow === 'none');

        if (viewToShow === 'create') createEventView.classList.remove('hidden');
        else if (viewToShow === 'available') viewEventAvailable.classList.remove('hidden');
        else if (viewToShow === 'full') viewEventFull.classList.remove('hidden');
    }

    // =================================================================
    // EVENT HANDLERS
    // =================================================================
    function handleDateClick(e) {
        const cell = e.target.closest('.date-cell');
        if (!cell) return;
        document.querySelector('.date-cell.bg-blue-200')?.classList.remove('bg-blue-200', 'text-white');
        cell.classList.add('bg-blue-200', 'text-white');
        selectedDate = cell.dataset.date;
        dailyScheduleContainer.classList.remove('hidden');
        showEventDetailView('none');
        renderDailySchedule(selectedDate);
    }

    function handleTimeSlotClick(e) {
        const slot = e.target.closest('.time-slot');
        if (!slot) return;
        selectedTimeSlot = slot.dataset.time;
        const slotType = slot.dataset.type;
        const eventData = JSON.parse(slot.dataset.event);
        selectedEventId = eventData.id || null;

        if (slotType === 'empty') {
            showEventDetailView('create');
            document.getElementById('create-event-date-time').textContent = `${selectedDate} at ${selectedTimeSlot}`;
            const allSlots = Array.from(scheduleSlotsContainer.querySelectorAll('.time-slot'));
            const clickedSlotIndex = allSlots.findIndex(s => s.dataset.time === selectedTimeSlot);
            let consecutiveEmptySlots = 0;
            for (let i = clickedSlotIndex; i < allSlots.length; i++) {
                if (allSlots[i].dataset.type === 'empty') consecutiveEmptySlots++;
                else break;
            }
            const availableMinutes = consecutiveEmptySlots * 30;
            document.querySelectorAll('.duration-btn').forEach(btn => {
                const duration = parseInt(btn.dataset.duration, 10);
                btn.disabled = duration > availableMinutes;
                btn.classList.toggle('opacity-40', duration > availableMinutes);
                btn.classList.toggle('cursor-not-allowed', duration > availableMinutes);
                btn.classList.toggle('bg-gray-100', duration > availableMinutes);
            });
            selectedDuration = null;
            document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
        } else {
            const endTime = new Date(`${selectedDate}T${eventData.time}`);
            endTime.setMinutes(endTime.getMinutes() + eventData.duration);
            const endTimeStr = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
            const timeDisplay = `${eventData.time} - ${endTimeStr} (${eventData.duration} min)`;
            const participantsDisplay = `${eventData.current} / ${eventData.max}`;
            const creatorIdDisplay = eventData.creator.id;
            const creatorContactDisplay = eventData.creator.phone;

            if (slotType === 'available') {
                showEventDetailView('available');
                document.getElementById('view-available-date').textContent = selectedDate;
                document.getElementById('view-available-time').textContent = timeDisplay;
                document.getElementById('view-available-participants').textContent = participantsDisplay;
                document.getElementById('view-available-creator-id').textContent = creatorIdDisplay;
                document.getElementById('view-available-creator-contact').textContent = creatorContactDisplay;
            } else if (slotType === 'full') {
                showEventDetailView('full');
                document.getElementById('view-full-date').textContent = selectedDate;
                document.getElementById('view-full-time').textContent = timeDisplay;
                document.getElementById('view-full-participants').textContent = participantsDisplay;
                document.getElementById('view-full-creator-id').textContent = creatorIdDisplay;
                document.getElementById('view-full-creator-contact').textContent = creatorContactDisplay;
            }
        }
    }

    function handleCreateEvent() {
        if (!selectedDate || !selectedTimeSlot || !selectedDuration) return showAlert("Please select a date, time, and duration.");
        const minParticipants = document.getElementById('min-participants').value;
        const maxParticipants = document.getElementById('max-participants').value;
        if (parseInt(minParticipants) > parseInt(maxParticipants)) return showAlert("Minimum participants cannot be greater than maximum.");

        const message = {
            action: 'create_event',
            date: selectedDate,
            time: selectedTimeSlot,
            duration: parseInt(selectedDuration),
            min_participants: parseInt(minParticipants),
            max_participants: parseInt(maxParticipants)
        };
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(message));
            showEventDetailView('none');
        } else {
            showAlert("WebSocket is not connected. Please refresh the page.");
        }
    }

    function handleSignupEvent() {
        if (!selectedEventId) return showAlert("No event selected.");
        const message = {
            action: 'signup_for_event',
            eventId: selectedEventId
        };
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(message));
            showEventDetailView('none');
        } else {
            showAlert("WebSocket is not connected. Please refresh the page.");
        }
    }

    // =================================================================
    // INITIALIZATION & EVENT LISTENERS
    // =================================================================
    const init = () => {
        const token = getToken();

        // 토큰이 없으면 즉시 로그인 페이지로 리디렉션하고 함수 종료
        if (!token) {
            window.location.href = '/login';
            return;
        }

        // 토큰이 있는 경우, 웹소켓 연결 시작 및 로더 표시
        showLoader();
        connectWebSocket();

        // Attach Event Listeners
        // document.addEventListener('DOMContentLoaded', init); // 이 부분은 삭제합니다.
        userMenu.addEventListener('click', () => userMenuDropdown.classList.toggle('hidden'));
        logoutBtn.addEventListener('click', handleLogout);
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); });
        calendarGrid.addEventListener('click', handleDateClick);
        scheduleSlotsContainer.addEventListener('click', handleTimeSlotClick);
        createEventBtn.addEventListener('click', handleCreateEvent);
        signupEventBtn.addEventListener('click', handleSignupEvent);
        durationOptions.addEventListener('click', (e) => {
            const btn = e.target.closest('.duration-btn');
            if (!btn || btn.disabled) return;
            document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
            btn.classList.add('bg-blue-500', 'text-white');
            selectedDuration = btn.dataset.duration;
        });
        document.addEventListener('click', (e) => { if (userMenu && !userMenu.contains(e.target)) userMenuDropdown.classList.add('hidden'); });

        // Initial Render
        renderCalendar(currentDate);
    };

    // DOMContentLoaded 이벤트 리스너를 한 번만 선언하고 init()을 호출
    document.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}