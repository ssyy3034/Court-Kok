{% extends "base.html" %}

{% block title %}Court-Kok 캘린더{% endblock %}  {# (I18N) #}

{% block content %}
<div class="w-full flex flex-col" style="min-height: calc(100vh - 2rem);">
  {% include 'includes/header.html' %}

  <!-- 칼럼 간 여백 추가 (UI) -->
  <main class="flex w-full flex-grow gap-6 md:gap-8">  {# (UI) #}
    {% include 'includes/calendar_view.html' %}
    {% include 'includes/daily_schedule.html' %}
    {% include 'includes/event_details.html' %}
  </main>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // === DOM Elements ===
  const userNameDisplay = document.getElementById('user-name-display');

  const calendarGrid = document.getElementById('calendar-grid');
  const currentMonthYearDisplay = document.getElementById('current-month-year');
  const prevMonthBtn = document.getElementById('prev-month-btn');
  const nextMonthBtn = document.getElementById('next-month-btn');

  const dailyScheduleContainer = document.getElementById('daily-schedule-container');
  const scheduleDateDisplay   = document.getElementById('schedule-date');
  const scheduleSlotsContainer= document.getElementById('schedule-slots');

  const eventDetailsContainer = document.getElementById('event-details-container');
  const createEventView       = document.getElementById('create-event-view');
  const viewEventAvailable    = document.getElementById('view-event-available');
  const viewEventFull         = document.getElementById('view-event-full');
  const durationOptions       = document.getElementById('duration-options');
  const createEventBtn        = document.getElementById('create-event-submit-btn');
  const signupEventBtn        = document.getElementById('signup-event-btn');

  // === State ===
  let currentDate = new Date();
  let selectedDate = null;
  let selectedTimeSlot = null;
  let selectedDuration = null;
  let selectedEventId = null;

  // --- 사용자명 표시 (전역 authedFetch 사용)
  (async () => {
    try {
      const res = await authedFetch('/api/user_info');
      if (res.ok) {
        const data = await res.json();
        if (userNameDisplay && data?.userName) userNameDisplay.textContent = data.userName;
      }
    } catch (_) {}
  })();

  // === UI Rendering ===
  function renderCalendar(date) {
    if (!calendarGrid || !currentMonthYearDisplay) return;
    calendarGrid.innerHTML = '';
    const year = date.getFullYear();
    const month = date.getMonth();
    currentMonthYearDisplay.textContent = `${year}년 ${month + 1}월`; // (I18N)

    const firstDayOfMonth = new Date(year, month, 1).getDay();
    const lastDateOfMonth = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDayOfMonth; i++) {
      calendarGrid.insertAdjacentHTML('beforeend', `<div></div>`);
    }
    for (let day = 1; day <= lastDateOfMonth; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const today = new Date();
      const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;

      // 선택/오늘 스타일 강화 (UI) — is-today 클래스는 기존 로직 유지
      const baseClass = 'date-cell h-12 flex items-center justify-center cursor-pointer rounded-lg transition-colors duration-150 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 text-gray-700'; // (UI)
      const todayClass = isToday
        ? 'bg-blue-500 text-white font-bold shadow-sm is-today'   // (UI)
        : 'hover:bg-gray-100';                                    // (UI)

      const cell = `<div class="${baseClass} ${todayClass}" data-date="${dateStr}" tabindex="0" role="button" aria-label="${day}일"> ${day} </div>`; // (UI)
      calendarGrid.insertAdjacentHTML('beforeend', cell);
    }
  }

  async function renderDailySchedule(dateStr) {
    showLoader();
    const [year, month, day] = dateStr.split('-');
    if (scheduleDateDisplay) scheduleDateDisplay.textContent = `${year}년 ${month}월 ${day}일`; // (I18N)

    try {
      const response = await authedFetch(`/api/events?date=${dateStr}`);
      if (!response.ok) throw new Error('일정 데이터를 불러오지 못했습니다.'); // (I18N)
      const data = await response.json();
      const events = data.events || [];

      const eventMap = new Map();
      events.forEach(event => {
        const startTime = event.time;
        for (let i = 0; i < event.duration; i += 30) {
          const slotDate = new Date(`${dateStr}T${startTime}:00`);
          slotDate.setMinutes(slotDate.getMinutes() + i);
          const slotTime = `${String(slotDate.getHours()).padStart(2, '0')}:${String(slotDate.getMinutes()).padStart(2, '0')}`;
          eventMap.set(slotTime, { isStart: i === 0, event });
        }
      });

      scheduleSlotsContainer.innerHTML = '';
      for (let hour = 8; hour < 22; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
          const slotEventInfo = eventMap.get(timeStr);

          // 라인/호버/포커스 스타일 개선 (UI)
          const borderClass = minute === 0 ? 'border-t-2 border-gray-400' : 'border-t border-dashed border-gray-300';
          let slotClass = 'bg-gray-200 hover:bg-gray-300 text-gray-600'; // (UI)
          let slotText = timeStr;
          let slotType = 'empty';
          let eventData = '{}';

          if (slotEventInfo) {
            const isFull = slotEventInfo.event.current >= slotEventInfo.event.max;
            slotClass = isFull ? 'bg-pink-300 text-white' : 'bg-green-300 text-white'; // (UI)
            slotType = isFull ? 'full' : 'available';
            eventData = JSON.stringify(slotEventInfo.event);
            if (slotEventInfo.isStart) {
              slotText = `${timeStr} · ${slotEventInfo.event.current} / ${slotEventInfo.event.max}명`; // (I18N)
            } else {
              slotText = `&nbsp;`;
              slotClass += ' opacity-80';
            }
          }

          const slot = `
            <div class="time-slot h-10 flex items-center px-3 text-sm ${borderClass} ${slotClass} cursor-pointer transition-colors duration-150 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400"
                 data-time="${timeStr}" data-type="${slotType}" data-event='${eventData}'
                 tabindex="0" role="button" aria-label="${timeStr}">
              ${slotText}
            </div>`; // (UI)
          scheduleSlotsContainer.insertAdjacentHTML('beforeend', slot);
        }
      }
    } catch (error) {
      if (error.message !== 'Unauthorized') {
        showAlert("일정을 불러오는 데 실패했습니다. 다시 시도해 주세요."); // (I18N)
      }
    } finally {
      hideLoader();
    }
  }

  function showEventDetailView(viewToShow) {
    if (!createEventView || !viewEventAvailable || !viewEventFull || !eventDetailsContainer) return;
    createEventView.classList.add('hidden');
    viewEventAvailable.classList.add('hidden');
    viewEventFull.classList.add('hidden');
    eventDetailsContainer.classList.toggle('hidden', viewToShow === 'none');
    if (viewToShow === 'create')   createEventView.classList.remove('hidden');
    if (viewToShow === 'available')viewEventAvailable.classList.remove('hidden');
    if (viewToShow === 'full')     viewEventFull.classList.remove('hidden');
  }

  function formatKoreanDate(dateStr) {
    const [y, m, d] = dateStr.split('-');
    return `${y}년 ${m}월 ${d}일`; // (I18N)
  }

  function handleDateClick(e) {
    const cell = e.target.closest('.date-cell');
    if (!cell) return;
    document.querySelectorAll('.date-cell.bg-blue-200, .date-cell.bg-blue-600').forEach(c => {
      c.classList.remove('bg-blue-200', 'bg-blue-600', 'text-white');
      if (c.classList.contains('is-today')) c.classList.add('bg-blue-500', 'text-white'); // (UI)
    });
    cell.classList.add('bg-blue-600', 'text-white'); // (UI)
    if (cell.classList.contains('is-today')) cell.classList.remove('bg-blue-500');
    selectedDate = cell.dataset.date;
    if (dailyScheduleContainer) dailyScheduleContainer.classList.remove('hidden');
    showEventDetailView('none');
    renderDailySchedule(selectedDate);
  }

  function handleTimeSlotClick(e) {
    const slot = e.target.closest('.time-slot');
    if (!slot) return;
    selectedTimeSlot = slot.dataset.time;
    const slotType = slot.dataset.type;
    const eventData = JSON.parse(slot.dataset.event || '{}');
    selectedEventId = eventData.id || null;

    if (slotType === 'empty') {
      showEventDetailView('create');
      const dt = document.getElementById('create-event-date-time');
      if (dt) dt.textContent = `${formatKoreanDate(selectedDate)} ${selectedTimeSlot}`; // (I18N)

      const allSlots = Array.from(scheduleSlotsContainer.querySelectorAll('.time-slot'));
      const clickedIndex = allSlots.findIndex(s => s.dataset.time === selectedTimeSlot);
      let consecutiveEmpty = 0;
      for (let i = clickedIndex; i < allSlots.length; i++) {
        if (allSlots[i].dataset.type === 'empty') consecutiveEmpty++; else break;
      }
      const availableMinutes = consecutiveEmpty * 30;
      document.querySelectorAll('.duration-btn').forEach(btn => {
        const duration = parseInt(btn.dataset.duration, 10);
        const disabled = duration > availableMinutes;
        btn.disabled = disabled;
        btn.classList.toggle('opacity-40', disabled);
        btn.classList.toggle('cursor-not-allowed', disabled);
      });
      selectedDuration = null;
      document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
    } else {
      const endTime = new Date(`${selectedDate}T${eventData.time}`);
      endTime.setMinutes(endTime.getMinutes() + eventData.duration);
      const endTimeStr = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
      const timeDisplay = `${eventData.time} - ${endTimeStr} (${eventData.duration}분)`; // (I18N)
      const participantsDisplay = `${eventData.current}명 / ${eventData.max}명`;         // (I18N)
      const creatorIdDisplay = eventData.creator?.id ?? '';
      const creatorContactDisplay = eventData.creator?.phone ?? '';
      const dateDisplay = formatKoreanDate(selectedDate);                                  // (I18N)

      if (slotType === 'available') {
        showEventDetailView('available');
        document.getElementById('view-available-date').textContent = dateDisplay;
        document.getElementById('view-available-time').textContent = timeDisplay;
        document.getElementById('view-available-participants').textContent = participantsDisplay;
        document.getElementById('view-available-creator-id').textContent = creatorIdDisplay;
        document.getElementById('view-available-creator-contact').textContent = creatorContactDisplay;
      } else if (slotType === 'full') {
        showEventDetailView('full');
        document.getElementById('view-full-date').textContent = dateDisplay;
        document.getElementById('view-full-time').textContent = timeDisplay;
        document.getElementById('view-full-participants').textContent = participantsDisplay;
        document.getElementById('view-full-creator-id').textContent = creatorIdDisplay;
        document.getElementById('view-full-creator-contact').textContent = creatorContactDisplay;
      }
    }
  }

  async function handleCreateEvent() {
    if (!selectedDate || !selectedTimeSlot || !selectedDuration)
      return showAlert("날짜, 시간, 진행 시간을 선택해주세요."); // (I18N)

    const minParticipants = document.getElementById('min-participants').value;
    const maxParticipants = document.getElementById('max-participants').value;

    if (+minParticipants > +maxParticipants)
      return showAlert("최소 인원은 최대 인원보다 많을 수 없습니다."); // (I18N)
    if (+minParticipants <= 0 || +maxParticipants <= 0)
      return showAlert("참여 인원은 1명 이상이어야 합니다.");         // (I18N)

    showLoader();
    try {
      const response = await authedFetch('/api/events', {
        method: 'POST',
        body: JSON.stringify({
          date: selectedDate,
          time: selectedTimeSlot,
          duration: parseInt(selectedDuration),
          min_participants: parseInt(minParticipants),
          max_participants: parseInt(maxParticipants)
        })
      });
      const result = await response.json();
      if (response.ok) {
        showAlert(result.message);
        showEventDetailView('none');
        await renderDailySchedule(selectedDate);
      } else {
        showAlert(result.message || "모임 생성에 실패했습니다."); // (I18N)
      }
    } catch (error) {
      if (error.message !== 'Unauthorized') showAlert("모임 생성에 실패했습니다."); // (I18N)
    } finally {
      hideLoader();
    }
  }

  async function handleSignupEvent() {
    if (!selectedEventId) return showAlert("선택된 모임이 없습니다."); // (I18N)
    showLoader();
    try {
      const response = await authedFetch(`/api/events/${selectedEventId}/signup`, { method: 'POST' });
      const result = await response.json();
      if (response.ok) {
        showAlert(result.message);
        showEventDetailView('none');
        await renderDailySchedule(selectedDate);
      } else {
        showAlert(result.message || "참가 신청에 실패했습니다."); // (I18N)
      }
    } catch (error) {
      if (error.message !== 'Unauthorized') showAlert("참가 신청에 실패했습니다."); // (I18N)
    } finally {
      hideLoader();
    }
  }

  // === WebSocket: 전역 사용 & 이 페이지 전용 리스너만 추가 (헤더 스크립트와 충돌 없음) ===
  connectWebSocket();
  const onWsMessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      if (data.type === 'event_update' && data.date === selectedDate) {
        renderDailySchedule(selectedDate);
      }
    } catch (_) {}
  };
  if (window.ws) {
    window.ws.addEventListener('message', onWsMessage);
  } else {
    window.addEventListener('ws:open', () => { if (window.ws) window.ws.addEventListener('message', onWsMessage); });
  }

  // === INITIALIZATION ===
  const init = async () => {
    showLoader();
    try {
      if (prevMonthBtn) prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); });
      if (nextMonthBtn) nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); });
      if (calendarGrid) calendarGrid.addEventListener('click', handleDateClick);
      if (scheduleSlotsContainer) scheduleSlotsContainer.addEventListener('click', handleTimeSlotClick);
      if (createEventBtn) createEventBtn.addEventListener('click', handleCreateEvent);
      if (signupEventBtn) signupEventBtn.addEventListener('click', handleSignupEvent);
      if (durationOptions) {
        durationOptions.addEventListener('click', (e) => {
          const btn = e.target.closest('.duration-btn');
          if (!btn || btn.disabled) return;
          document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
          btn.classList.add('bg-blue-500', 'text-white'); // (UI)
          selectedDuration = btn.dataset.duration;
        });
      }

      renderCalendar(currentDate);
      const todayCell = document.querySelector('.date-cell.is-today');
      if (todayCell) todayCell.click();
      else {
        const firstDayCell = document.querySelector('.date-cell');
        if (firstDayCell) firstDayCell.click();
      }
    } catch (error) {
      if (error.message !== 'Unauthorized') {
        console.error("Initialization failed:", error);
        showAlert("페이지 초기화에 실패했습니다."); // (I18N)
      }
    } finally {
      hideLoader();
    }
  };

  init();
});
</script>
{% endblock %}
